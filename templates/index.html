<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PCHHXR2S');</script>
<!-- End Google Tag Manager -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MotoPower - Tienda de Motos</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='estilos.css') }}">
  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    /* Estilos b√°sicos para las nuevas secciones (puedes moverlos a estilos.css) */
    .login, .contacto {
        max-width: 400px;
        margin: 40px auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    }
    .login h2, .contacto h2 {
        text-align: center;
        color: #f39c12;
    }
    .login button, .contacto button {
        background-color: #f39c12;
        color: white;
        border: none;
        padding: 10px;
        cursor: pointer;
        width: 100%;
        margin-top: 15px;
    }
    /* Estilos generales (asumiendo que 'estilos.css' existe) */
    .logo { display: flex; align-items: center; }
    .logo img { width: 50px; margin-right: 10px; }
    .slides { display: flex; transition: transform 0.5s ease-in-out; }
    .slides img { width: 100%; flex-shrink: 0; }
  </style>
</head>

<body>
  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PCHHXR2S"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<div id="carrito-panel" class="carrito-panel">
  <h3>üõí Tu carrito</h3>
  <ul id="lista-carrito"></ul>
  <p id="total-carrito"></p>
  <button onclick="vaciarCarrito()">Vaciar</button>
  <button class="btn-pagar" onclick="abrirCheckout()">Pagar</button>
</div>

<header>
    <div class="logo">
         <img src="https://static.vecteezy.com/system/resources/thumbnails/026/972/734/small/black-motorcycle-club-logo-isolated-png.png"width="200" height="80" alt="Logo MotoPower">
      <h1>MotoPower</h1>
    </div>
    <p>Velocidad, potencia y estilo sobre dos ruedas </p>
   
    <button class="btn-carrito" id="btn-carrito" onclick="toggleCarrito()">

  üõí Carrito (<span id="contador-carrito">0</span>)
</button>

</header>

  <nav class="botones">
    <button onclick="window.location.href='#catalogo'">Cat√°logo</button>
    <button onclick="window.location.href='#servicios'">Servicios</button>
    <button onclick="window.location.href='#inventario'">Inventario</button>
    <button onclick="window.location.href='#contacto'">Contacto</button>
    <div class="auth-container">
  <button id="btn-auth" type="button">
    <span id="auth-icon">üîê</span>
    <span id="auth-text">Iniciar sesi√≥n</span>
  </button>

  <div id="profile-menu" class="profile-menu">
    <div class="profile-item">üë§ Perfil</div>
    <div class="profile-item" id="logout-btn">üö™ Cerrar sesi√≥n</div>
  </div>
</div>

  </nav>
  
<div id="auth-modal">
  <div class="auth-panel">
    <div class="close" id="close-auth">‚úñ</div>

    <!-- LOGIN -->
    <div id="login-panel">
      <h2>Iniciar sesi√≥n</h2>
      <input type="email" id="login-email">
      <input type="password" id="login-password">
      <button id="login-btn">Entrar</button>
      <p id="login-feedback"></p>
      <div class="switch" id="go-register">¬øNo tienes cuenta? Reg√≠strate</div>
    </div>

    <!-- REGISTRO -->
    <div id="register-panel" style="display:none;">
      <h2>Registrarse</h2>
      <input type="email" id="register-email">
      <input type="password" id="register-password">
      <button id="register-btn">Crear cuenta</button>
      <p id="register-feedback"></p>
      <div class="switch" id="go-login">¬øYa tienes cuenta? Inicia sesi√≥n</div>
    </div>

  </div>
</div>


  <section class="carrusel">
    <div class="slides">
     <img src="https://dhqlmcogwd1an.cloudfront.net/images/phocagallery/yamaha/yzf-r15/01-yamaha-yzf-r15-2022-estudio-azul-620.jpg" alt="Yamaha">

      <img src="https://www.honda.mx/web/img/motorcycles/models/naked/cb650r/gallery/1.jpg" alt="Honda">
      <img src="https://images.squarespace-cdn.com/content/v1/639bda5c64492137de0500b9/1671321053359-UM5XS07LCXP787EFH84H/1e0d7bb4-af05-44ac-bdaa-e986ce460e9e.jpg?format=1000w" alt="Kawasaki Z900">
    </div>
  </section>

  <section id="catalogo" class="catalogo">
    <h2>Cat√°logo de Motos</h2>
    <div class="productos">
      <div class="tarjeta">
        <img src="https://www.motorbikemag.es/wp-content/uploads/2024/10/Kawasaki-Z900-2025-estaticas3.jpg"width="800" height="200" alt="Z900">
        <h3>Kawasaki Z900</h3>
        <p>Motor de 948cc, 123 HP. Ideal para los amantes de la potencia.</p>
       <button
  onclick="agregarAlCarrito(
    'Kawasaki Z900',
    350000,
    'https://www.motorbikemag.es/wp-content/uploads/2024/10/Kawasaki-Z900-2025-estaticas3.jpg'
  )">
  üõí Comprar
</button>



      </div>
      <div class="tarjeta">
        <img src="https://cdn.shopify.com/s/files/1/0066/0334/1924/files/moto-honda-CB650R-1_1024x1024.webp?v=1712321399"width="800" height="200" alt="CB650R">
        <h3>Honda CB650R</h3>
        <p>Motor 649cc, dise√±o naked agresivo y rendimiento confiable.</p>
       <button
  onclick="agregarAlCarrito(
    'Honda CB650R',
    320000,
    'https://cdn.shopify.com/s/files/1/0066/0334/1924/files/moto-honda-CB650R-1_1024x1024.webp?v=1712321399'
  )">
  üõí Comprar
</button>




      </div>
      <div class="tarjeta">
        <img src="https://autoshowtv.com.mx/wp-content/uploads/2024/11/YZF-R15-V4.jpg"width="800" height="200" alt="R15 V4">
        <h3>Yamaha R15 V4</h3>
        <p>Motor 155cc, ideal para ciudad con estilo deportivo.</p>
       <button
  onclick="agregarAlCarrito(
    'Yamaha R15 V4',
    85000,
    'https://autoshowtv.com.mx/wp-content/uploads/2024/11/YZF-R15-V4.jpg'
  )">
  üõí Comprar
</button>



      </div>
    </div>
  </section>

  <section id="servicios" class="servicios">
    <h2>Servicios disponibles</h2>
    <ul>
      <li>üîß Mantenimiento preventivo y correctivo</li>
      <li>üß¢ Venta de accesorios y equipo de protecci√≥n</li>
      <li>üí≥ Financiamiento flexible y seguros</li>
      <li>üöö Env√≠os a todo M√©xico</li>
    </ul>
  </section>
  
 
  <section id="inventario" class="inventario" style="display:none;">

    <h2>Inventario Actual (Requiere Login)</h2>
    <table>
      <thead>
        <tr>
          <th>Modelo</th>
          <th>Marca</th>
          <th>Cilindraje</th>
          <th>Disponibles</th>
          <th>Precio</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="inventario-body">
        <tr><td colspan="5">Inicia sesi√≥n para ver el inventario.</td></tr>
      </tbody>
    </table>
    <h3>Agregar / Editar moto</h3>

<form id="form-moto">
  <input type="hidden" id="moto-id">

  <input type="text" id="modelo" placeholder="Modelo" required>
  <input type="text" id="marca" placeholder="Marca" required>
  <input type="text" id="cilindraje" placeholder="Cilindraje" required>
  <input type="number" id="disponibles" placeholder="Disponibles" required>
  <input type="number" id="precio" placeholder="Precio" required>

  <button type="submit">Guardar</button>
</form>

<h2>Usuarios Registrados</h2>

<table>
  <thead>
    <tr>
      <th>Email</th>
      <th>Rol</th>
      <th>Acciones</th>

    </tr>
  </thead>
  <tbody id="usuarios-body">
    <tr>
      <td colspan="2">Cargando usuarios...</td>
      
    </tr>
  </tbody>
</table>


  </section>

  <section id="contacto" class="contacto">
    <h2>Cont√°ctanos</h2>
    <form id="formulario-contacto"> 
      <label for="nombre">Nombre:</label>
      <input type="text" id="nombre" required>

      <label for="correo">Correo electr√≥nico:</label>
      <input type="email" id="correo" required>

      <label for="mensaje">Mensaje:</label>
      <textarea id="mensaje" rows="4" required></textarea>

      <button type="submit">Enviar mensaje</button>
      <p id="mensaje-feedback" style="margin-top: 10px;"></p>
    </form>
  </section>
<section id="mapa-section">
  <h2>Concesionarias cercanas</h2>
  <div id="mapa" style="height: 400px; width: 100%; border-radius: 10px;"></div>
</section>

<footer>
    <p>&copy; 2025 MotoPower - Todos los derechos reservados</p>
    <p>S√≠guenos en:
      <a href="https://www.facebook.com/profile.php?id=61584828976426&rdid=XLlsZRvk7vxRDMHQ&share_url=https%3A%2F%2Fwww.facebook.com%2Fshare%2F1NkGCsdMcc%2F#" target="_blank">Facebook</a> |
      <a href="https://www.instagram.com/motp.ower?igsh=dTAwdm45aTRsNnBx" target="_blank">Instagram</a>
    </p>
</footer>

<!-- MODAL CHECKOUT -->
<div id="checkout-modal" class="checkout-modal">
  <div class="checkout-panel">

    <h2>Checkout</h2>

    <form id="checkout-form">
      <label>Nombre completo</label>
      <input type="text" required>

      <label>Correo electr√≥nico</label>
      <input type="email" required>

      <label>Direcci√≥n</label>
      <input type="text" required>

      <label>M√©todo de pago</label>
      <select required>
        <option value="">Selecciona</option>
        <option>Tarjeta</option>
        <option>Transferencia</option>
        <option>Efectivo</option>
      </select>

      <button type="submit" id="btn-confirmar">
  Confirmar compra
</button>

    </form>

    <div class="close-checkout" onclick="cerrarCheckout()">‚úñ</div>
  </div>
</div>

<!-- MODAL PAGO -->
<div id="pago-modal" class="checkout-modal">
  <div class="checkout-panel">

    <h2 id="titulo-pago">Pago</h2>

    <form id="pago-form">
      <div id="campos-pago"></div>

      <button type="submit">
        Pagar ahora
      </button>
    </form>

    <div class="close-checkout" onclick="cerrarPago()">‚úñ</div>

  </div>
</div>

<!-- MODAL RESULTADO -->
<div id="resultado-modal" class="checkout-modal">
  <div class="checkout-panel resultado">
    <h2 id="resultado-texto"></h2>
    <div class="icono-resultado" id="icono-resultado"></div>
  </div>
</div>


  <script>
    
    // URL DE RENDER APLICADA para el backend
    const API_BASE_URL =
  location.hostname === "localhost" || location.hostname === "127.0.0.1"
    ? "http://127.0.0.1:5000/api"
    : "https://motoschingonas.onrender.com/api";


    
    // ----------------------------------------------------------------------
    // FUNCIONES DE LOGIN Y REGISTRO
    // ----------------------------------------------------------------------

   function verificarEstadoLogin() {
  const token = localStorage.getItem('userToken');
  const role = localStorage.getItem('userRole');

  if (token) {
    if (role === 'admin') {
      cargarInventario();
      cargarUsuarios();
    }
    actualizarEstadoUI();
  } else {
    actualizarEstadoUI();
  }

  fetch(`${API_BASE_URL}/carrito`, {
  headers: {
    "X-User-Email": localStorage.getItem("userEmail")
  }
})
.then(res => res.json())
.then(data => {
  if (Array.isArray(data)) {
    carrito = data;
  } else {
    carrito = [];
  }
  actualizarCarrito();
});


}

    async function manejarRegistro(event) {
        event.preventDefault();

        const url = `${API_BASE_URL}/register`;
        const feedback = document.getElementById('register-feedback');
        
        const datosRegistro = {
            email: document.getElementById('register-email').value,
            password: document.getElementById('register-password').value,
        };

        feedback.textContent = 'Registrando...';
        feedback.style.color = 'gray';

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datosRegistro)
            });

            const resultado = await response.json();
            
            feedback.textContent = resultado.mensaje;
            feedback.style.color = response.ok ? 'green' : 'red';
            
            if (response.ok) {
               document.getElementById('register-email').value = '';
document.getElementById('register-password').value = '';

            }

        } catch (error) {
            console.error('Error de conexi√≥n al intentar registrar:', error);
            feedback.textContent = 'Error de conexi√≥n con el servidor.';
            feedback.style.color = 'red';
        }
    }

    async function manejarLogin(event) {
  event.preventDefault();

  const url = `${API_BASE_URL}/login`;
  const feedback = document.getElementById('login-feedback');

  const datosLogin = {
    email: document.getElementById('login-email').value.trim(),
    password: document.getElementById('login-password').value.trim(),
  };

  feedback.textContent = 'Verificando...';
  feedback.style.color = 'gray';

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(datosLogin)
    });

    const resultado = await response.json();
    console.log("LOGIN BACKEND RESPONSE:", resultado);

    if (response.ok && resultado.token) {
      feedback.textContent = '¬°Inicio de sesi√≥n exitoso!';
      feedback.style.color = 'green';

      // Guardar token
      localStorage.setItem('userToken', resultado.token);

      // Si el backend no maneja roles ‚Üí usuario normal
      localStorage.setItem('userRole', resultado.role || 'user');
      localStorage.setItem('userEmail', resultado.usuario);

      verificarEstadoLogin();
      actualizarEstadoUI();

      setTimeout(() => {
        document.getElementById('auth-modal').classList.remove('active');
        feedback.textContent = '';
        document.getElementById('login-password').value = '';
      },800);

    } else {
      feedback.textContent = resultado.mensaje || 'Credenciales inv√°lidas';
      feedback.style.color = 'red';
    }

  } catch (error) {
    console.error('Error de conexi√≥n:', error);
    feedback.textContent = 'Error de conexi√≥n con el servidor';
    feedback.style.color = 'red';
  }
  

}

        
    
    // ----------------------------------------------------------------------
    // FUNCIONES DE INVENTARIO Y CONTACTO
    // ----------------------------------------------------------------------

    async function cargarInventario() {
  const token = localStorage.getItem('userToken');
  const role = localStorage.getItem('userRole');
  const tablaBody = document.getElementById('inventario-body');

  if (!tablaBody) return;

  if (!token) {
    tablaBody.innerHTML = `<tr><td colspan="5">Inicia sesi√≥n para ver el inventario.</td></tr>`;
    return;
  }

  if (role !== 'admin') {
    tablaBody.innerHTML = `<tr><td colspan="5">No tienes permisos para ver el inventario.</td></tr>`;
    return;
  }

  try {
    const response = await fetch(`${API_BASE_URL}/inventario`, {
      headers: {
        "X-User-Role": role
      }
    });

    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status}`);
    }

    const inventario = await response.json();
    tablaBody.innerHTML = '';

    inventario.forEach(moto => {
      const row = tablaBody.insertRow();
      row.insertCell(0).textContent = moto.modelo;
      row.insertCell(1).textContent = moto.marca;
      row.insertCell(2).textContent = moto.cilindraje;
      row.insertCell(3).textContent = moto.disponibles;
      row.insertCell(4).textContent = new Intl.NumberFormat(
        'es-MX',
        { style: 'currency', currency: 'MXN' }
      ).format(moto.precio);
      const acciones = row.insertCell(5);
acciones.innerHTML = `
  <button onclick="editarMoto(${moto.id})">‚úèÔ∏è</button>
  <button onclick="eliminarMoto(${moto.id})">üóëÔ∏è</button>
`;
    });

  } catch (error) {
    console.error('Error al cargar inventario:', error);
    tablaBody.innerHTML =
      `<tr><td colspan="5">Error al cargar inventario.</td></tr>`;
  }
}

    
    async function enviarFormularioContacto(event) {
        event.preventDefault(); 

        const url = `${API_BASE_URL}/contacto`;
        const feedback = document.getElementById('mensaje-feedback');
        
        const datos = {
            nombre: document.getElementById('nombre').value,
            correo: document.getElementById('correo').value,
            mensaje: document.getElementById('mensaje').value,
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });

            const resultado = await response.json();
            
            feedback.textContent = resultado.mensaje;
            feedback.style.color = response.ok ? 'green' : 'red';

            if (response.ok) {
                document.getElementById('formulario-contacto').reset(); 
            }

        } catch (error) {
            console.error('Error al enviar formulario:', error);
            feedback.textContent = 'Hubo un error de conexi√≥n con el servidor.';
            feedback.style.color = 'red';
        }
    }

   function actualizarEstadoUI() {
  const token = localStorage.getItem('userToken');
  const role = localStorage.getItem('userRole');

  const authIcon = document.getElementById('auth-icon');
  const authText = document.getElementById('auth-text');
  const inventario = document.getElementById('inventario');
  const profileMenu = document.getElementById('profile-menu');
  const botonCarrito = document.getElementById('btn-carrito');

  if (token) {
    authIcon.textContent = 'üë§';
    authText.textContent = role === 'admin' ? 'Admin' : 'Usuario';

    if (botonCarrito) botonCarrito.style.display = 'block';

    if (role === 'admin') {
      inventario.style.display = 'block';
    }
  } else {
    authIcon.textContent = 'üîê';
    authText.textContent = 'Iniciar sesi√≥n';

    if (botonCarrito) botonCarrito.style.display = 'none';

    inventario.style.display = 'none';
    profileMenu.style.display = 'none';
  }
}




document.getElementById('logout-btn').onclick = () => {
  localStorage.removeItem('userToken');
  localStorage.removeItem('userRole');
  actualizarEstadoUI();
};



    // ----------------------------------------------------------------------
    // EJECUCI√ìN AL CARGAR EL DOCUMENTO
    // ----------------------------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
  
  verificarEstadoLogin(); 
  actualizarEstadoUI();


  // BOTONES DEL MODAL
  document.getElementById('login-btn').addEventListener('click', manejarLogin);
  document.getElementById('register-btn').addEventListener('click', manejarRegistro);

  // FORMULARIO DE CONTACTO (ESTE S√ç EXISTE)
  document.getElementById('formulario-contacto')
    .addEventListener('submit', enviarFormularioContacto);

  // MODAL
  const authModal = document.getElementById('auth-modal');

  document.getElementById('btn-auth').onclick = () => {
  const token = localStorage.getItem('userToken');

  if (!token) {
    // NO hay sesi√≥n ‚Üí abrir login
    authModal.classList.add('active');
  } else {
    // S√ç hay sesi√≥n ‚Üí abrir men√∫ de perfil
    toggleProfileMenu();
  }
};

function toggleProfileMenu() {
  const menu = document.getElementById('profile-menu');
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

  document.getElementById('close-auth').onclick = () => {
    authModal.classList.remove('active');
  };

  document.getElementById('go-register').onclick = () => {
    document.getElementById('login-panel').style.display = 'none';
    document.getElementById('register-panel').style.display = 'block';
  };

  document.getElementById('go-login').onclick = () => {
    document.getElementById('register-panel').style.display = 'none';
    document.getElementById('login-panel').style.display = 'block';
  };
});


    // Script carrusel
    let index = 0;
    const slides = document.querySelector('.slides');
    const total = slides.children.length;

    setInterval(() => {
      index = (index + 1) % total;
      if (slides) { 
          slides.style.transform = `translateX(-${index * 100}%)`;
      }
    }, 3000);
function actualizarBotonAuth() {
  const token = localStorage.getItem('userToken');
  

  const icon = document.getElementById('auth-icon');
  const text = document.getElementById('auth-text');
//comentario
  if (token ) {
    icon.textContent = 'üë§';
    text.textContent = `Bienvenido`;
  } else {
    icon.textContent = 'üîê';
    text.textContent = 'Iniciar sesi√≥n';
  }
}

let carrito = [];

function toggleCarrito() {
  const panel = document.getElementById("carrito-panel");
  panel.style.display = panel.style.display === "block" ? "none" : "block";
}

function agregarAlCarrito(modelo, precio, imagen) {
  if (!Array.isArray(carrito)) {
    carrito = [];
  }

  carrito.push({
    modelo,
    precio,
    imagen,
    cantidad: 1
  });

  actualizarCarrito();

  fetch(`${API_BASE_URL}/carrito`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-User-Email": localStorage.getItem("userEmail")
    },
    body: JSON.stringify({
      modelo,
      precio,
      imagen,
      cantidad: 1
    })
  });
}



function actualizarCarrito() {
  const lista = document.getElementById("lista-carrito");
  const totalTexto = document.getElementById("total-carrito");
  const contador = document.getElementById("contador-carrito");

  lista.innerHTML = "";
  let total = 0;

  carrito.forEach(item => {
    const li = document.createElement("li");
li.style.display = "flex";
li.style.alignItems = "center";
li.style.marginBottom = "10px";

const img = document.createElement("img");
img.src = item.imagen;
img.style.width = "60px";
img.style.borderRadius = "6px";
img.style.marginRight = "10px";

const texto = document.createElement("span");
texto.textContent = `${item.modelo} - $${item.precio.toLocaleString()}`;

li.appendChild(img);
li.appendChild(texto);
lista.appendChild(li);

    total += item.precio;
  });

  contador.textContent = carrito.length;
  totalTexto.textContent = `Total: $${total.toLocaleString()}`;
}

function vaciarCarrito() {
  carrito = [];
  actualizarCarrito();
}

/* ===== CHECKOUT ===== */

function abrirCheckout() {
  if (carrito.length === 0) {
    alert("Tu carrito est√° vac√≠o");
    return;
  }
  document.getElementById("checkout-modal").classList.add("active");
}

function cerrarCheckout() {
  document.getElementById("checkout-modal").classList.remove("active");
}

document.getElementById("checkout-form").addEventListener("submit", function (e) {
  e.preventDefault();

  cerrarCheckout(); // cierra datos personales
  abrirPago();      // abre m√©todo de pago
});
/* ===== PASO 5 ‚Äì ABRIR PAGO SEG√öN M√âTODO ===== */

function abrirPago() {
  const metodo = document.querySelector('#checkout-form select').value;
  const campos = document.getElementById("campos-pago");
  const titulo = document.getElementById("titulo-pago");

  if (!metodo) {
    alert("Selecciona un m√©todo de pago");
    return;
  }

  campos.innerHTML = "";
  titulo.textContent = `Pago con ${metodo}`;

  if (metodo === "Tarjeta") {
    campos.innerHTML = `
      <label>N√∫mero de tarjeta</label>
      <input required placeholder="1234 5678 9012 3456">

      <label>Fecha</label>
      <input required placeholder="MM/AA">

      <label>CVV</label>
      <input required placeholder="123">
    `;
  }

  if (metodo === "Transferencia") {
    campos.innerHTML = `
      <p>CLABE: <b>012345678901234567</b></p>
      <p>Banco: BBVA</p>
    `;
  }

  if (metodo === "Efectivo") {
    campos.innerHTML = `
      <p>C√≥digo de pago:</p>
      <h3>${Math.floor(Math.random() * 900000) + 100000}</h3>
    `;
  }

  document.getElementById("pago-modal").classList.add("active");
}

function cerrarPago() {
  document.getElementById("pago-modal").classList.remove("active");
}

/* ===== PASO 6 ‚Äì PROCESAR PAGO ===== */

document.getElementById("pago-form").addEventListener("submit", function (e) {
  e.preventDefault();

  cerrarPago(); // cerrar modal de pago

  const aprobado = Math.random() > 0.3; // 70% √©xito

  const modal = document.getElementById("resultado-modal");
  const texto = document.getElementById("resultado-texto");
  const icono = document.getElementById("icono-resultado");

  if (aprobado) {
    texto.textContent = "Pago aprobado üéâ";
    icono.textContent = "‚úÖ";
    vaciarCarrito();
  } else {
    texto.textContent = "Pago rechazado ‚ùå";
    icono.textContent = "‚ö†Ô∏è";
  }

  modal.classList.add("active");

  setTimeout(() => {
    modal.classList.remove("active");
  }, 3000);
});


document.addEventListener('click', function (event) {
  const carritoPanel = document.getElementById('carrito-panel');
  const botonCarrito = document.querySelector('.btn-carrito');

  // Si el carrito NO est√° abierto, no hacemos nada
  if (carritoPanel.style.display !== 'block') return;

  // Si el click fue dentro del carrito, NO cerrar
  if (carritoPanel.contains(event.target)) return;

  // Si el click fue en el bot√≥n carrito, NO cerrar
  if (botonCarrito.contains(event.target)) return;

  // Si fue fuera ‚Üí cerrar carrito
  carritoPanel.style.display = 'none';
});

function cerrarSesion() {
  localStorage.removeItem('userToken');
  localStorage.removeItem('userRole');
  actualizarEstadoUI();
}

document.getElementById('form-moto').addEventListener('submit', guardarMoto);

async function guardarMoto(e) {
  e.preventDefault();

  const id = document.getElementById('moto-id').value;
  const role = localStorage.getItem('userRole');

  if (role !== 'admin') return alert('No autorizado');

  const moto = {
    modelo: document.getElementById('modelo').value,
    marca: document.getElementById('marca').value,
    cilindraje: document.getElementById('cilindraje').value,
    disponibles: Number(document.getElementById('disponibles').value),
    precio: Number(document.getElementById('precio').value),
  };

  const url = id
    ? `${API_BASE_URL}/inventario/${id}`
    : `${API_BASE_URL}/inventario`;

  const method = id ? 'PUT' : 'POST';

  await fetch(url, {
    method,
    headers: {
      'Content-Type': 'application/json',
      'X-User-Role': 'admin'
    },
    body: JSON.stringify(moto)
  });

  document.getElementById('form-moto').reset();
  document.getElementById('moto-id').value = '';

  cargarInventario();
}

function editarMoto(id) {
  fetch(`${API_BASE_URL}/inventario`, {
    headers: { 'X-User-Role': 'admin' }
  })
    .then(res => res.json())
    .then(inventario => {
      const moto = inventario.find(m => m.id === id);

      document.getElementById('moto-id').value = moto.id;
      document.getElementById('modelo').value = moto.modelo;
      document.getElementById('marca').value = moto.marca;
      document.getElementById('cilindraje').value = moto.cilindraje;
      document.getElementById('disponibles').value = moto.disponibles;
      document.getElementById('precio').value = moto.precio;
    });
}


async function eliminarMoto(id) {
  const confirmar = confirm("¬øSeguro que deseas eliminar esta moto?");
  if (!confirmar) return;

  const role = localStorage.getItem("userRole");

  try {
    const response = await fetch(`${API_BASE_URL}/inventario/${id}`, {
      method: "DELETE",
      headers: {
        "X-User-Role": role
      }
    });

    const data = await response.json();

    if (!response.ok) {
      alert(data.mensaje || "Error al eliminar");
      return;
    }

    alert("Moto eliminada correctamente");
    cargarInventario(); // üîÑ refresca tabla

  } catch (error) {
    console.error("Error al eliminar:", error);
    alert("Error de conexi√≥n");
  }
}

async function cargarUsuarios() {
  const role = localStorage.getItem('userRole');
  const tablaBody = document.getElementById('usuarios-body');

  if (!tablaBody) return;
  if (role !== 'admin') return;

  try {
    const response = await fetch(`${API_BASE_URL}/usuarios`, {
      headers: {
        "X-User-Role": role
      }
    });

    if (!response.ok) {
      throw new Error("No autorizado");
    }

    const usuarios = await response.json();
    tablaBody.innerHTML = "";

usuarios.forEach(usuario => {
  const row = tablaBody.insertRow();

  row.insertCell(0).textContent = usuario.email;
  row.insertCell(1).textContent = usuario.role;

  const acciones = row.insertCell(2);
  acciones.innerHTML = `
    <button onclick="cambiarRol('${usuario.email}')">üîÑ</button>
    <button onclick="eliminarUsuario('${usuario.email}')">üóëÔ∏è</button>
  `;
});


  } catch (error) {
    console.error("Error al cargar usuarios:", error);
    tablaBody.innerHTML =
      `<tr><td colspan="2">Error al cargar usuarios</td></tr>`;
  }
}

async function eliminarUsuario(email) {
  if (!confirm("¬øEliminar usuario?")) return;

  await fetch(`${API_BASE_URL}/usuarios/${email}`, {
    method: "DELETE",
    headers: { "X-User-Role": "admin" }
  });

  cargarUsuarios();
}

async function cambiarRol(email) {
  const nuevoRol = prompt("Nuevo rol (admin/user):");

  if (!nuevoRol) return;

  await fetch(`${API_BASE_URL}/usuarios/${email}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "X-User-Role": "admin"
    },
    body: JSON.stringify({ role: nuevoRol })
  });

  cargarUsuarios();
}

async function buscarConcesionariasOSM(lat, lng, radioMetros = 5000) {

  const query = `
    [out:json];
    (
      node["shop"="motorcycle"](around:${radioMetros},${lat},${lng});
      node["amenity"="motorcycle_dealer"](around:${radioMetros},${lat},${lng});
      node["shop"="motorcycle_repair"](around:${radioMetros},${lat},${lng});
    );
    out;
  `;

  const url = "https://overpass-api.de/api/interpreter";

  const response = await fetch(url, {
    method: "POST",
    body: query
  });

  const data = await response.json();
  return data.elements;
}
let mapa;
let marcadores = [];

function limpiarMarcadores() {
  marcadores.forEach(m => mapa.removeLayer(m));
  marcadores = [];
}

async function iniciarMapa(lat, lng) {

  if (!mapa) {
    mapa = L.map('mapa').setView([lat, lng], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(mapa);
  }

  limpiarMarcadores();

  // Marcador usuario
  const userMarker = L.marker([lat, lng])
    .addTo(mapa)
    .bindPopup("Tu ubicaci√≥n")
    .openPopup();

  marcadores.push(userMarker);

  const concesionarias = await buscarConcesionariasOSM(lat, lng, 10000); // 10 km

  if (concesionarias.length === 0) {
    alert("No se encontraron concesionarias cercanas");
    return;
  }

  concesionarias.forEach(c => {
    const nombre = c.tags.name || "Concesionaria de motos";
    const marker = L.marker([c.lat, c.lon])
      .addTo(mapa)
      .bindPopup(nombre);

    marcadores.push(marker);
  });
}

function calcularDistancia(lat1, lon1, lat2, lon2) {
  const R = 6371; // radio de la Tierra en km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function obtenerConcesionariasCercanas(lat, lng, maxKm = 15) {
  return concesionarias.filter(c => {
    const distancia = calcularDistancia(lat, lng, c.lat, c.lng);
    return distancia <= maxKm;
  });
}

function iniciarMapa(lat, lng) {
  const mapa = L.map('mapa').setView([lat, lng], 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(mapa);

  // Usuario
  L.marker([lat, lng])
    .addTo(mapa)
    .bindPopup("Tu ubicaci√≥n")
    .openPopup();

  const cercanas = obtenerConcesionariasCercanas(lat, lng, 5);

  if (cercanas.length === 0) {
    alert("No hay concesionarias a menos de 5 km");
  }

  cercanas.forEach(c => {
    const distancia = calcularDistancia(lat, lng, c.lat, c.lng).toFixed(2);

    L.marker([c.lat, c.lng])
      .addTo(mapa)
      .bindPopup(`${c.nombre}<br>${distancia} km`);
  });
}
navigator.geolocation.getCurrentPosition(
  pos => iniciarMapa(pos.coords.latitude, pos.coords.longitude),
  () => iniciarMapa(19.3576, -99.0721)
);


</script>

</body>
</html>
